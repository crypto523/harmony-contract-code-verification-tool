import * as github from './github'
import * as truffle from './truffle'
import * as rpc from './rpc'
import path from 'path'
import fs from 'fs'
import { verifyByteCode } from './verify'

export const codeVerification = async (
  {
    contractAddress,
    solidityVersion,
    githubURL
  }
) => {
  const taskId = contractAddress
  const directory = path.join(__dirname, '../', taskId)

  try {
  // todo validate address SDK hmy isAddress
  // todo validate if folder already exist

  console.log('New task', { taskId, directory })

  console.log('Getting actual bytecode from the blockchain...')
  const actualBytecode = await rpc.getSmartContractCode(contractAddress)

  if (!actualBytecode || actualBytecode === '0x') {
    throw new Error(`No bytecode found for address ${contractAddress}`)
  }

  const commitHash1 = await github.getCommitHash()
  console.log(commitHash1)

  console.log('Cloning github...')
  try {
    await github.clone(githubURL, taskId)
    console.log('Creating truffle config...')
  } catch (e) {
    // console.warn(e)
  }

  await truffle.createConfiguration(solidityVersion, directory)
  // await truffle.createMigration(directory, githubURL)
  console.log('Installing contract dependencies...')
  await truffle.installDependencies(directory)
  console.log('Compiling...')
  await truffle.compile(directory)
  console.log('Getting compiled bytecode')
  const { deployedBytecode, bytecode } = await truffle.getByteCode(githubURL, directory)

  console.log('Cleaning up...')
  const verified = verifyByteCode(actualBytecode, deployedBytecode, solidityVersion)

  if (verified) {
    const commitHash = await github.getCommitHash()

    return {
      verified,
      commitHash
    }
  }

  } catch(error) {
    return {
      verified: false,
      error
    }
  }

  fs.rmdirSync(directory, { recursive: true })

  return {
    verified: false,
    error: 'No match'
  }
}


/*

'ipfs'.split('').map(a=>a.charCodeAt(0)).map(a=>a.toString(16)).join()



bytecode
0x6060604052341561000f57600080fd5b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061064d8061005e6000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063481c6a75146100695780635d495aea146100be5780638b5b9ccc146100d3578063e97dcb621461013d578063f71d96cb1461014757600080fd5b341561007457600080fd5b61007c6101aa565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156100c957600080fd5b6100d16101cf565b005b34156100de57600080fd5b6100e6610310565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561012957808201518184015260208101905061010e565b505050509050019250505060405180910390f35b6101456103a4565b005b341561015257600080fd5b610168600480803590602001909190505061041e565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561022c57600080fd5b60018054905061023a61045d565b81151561024357fe5b06905060018181548110151561025557fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc3073ffffffffffffffffffffffffffffffffffffffff16319081150290604051600060405180830381858888f1935050505015156102d757600080fd5b60006040518059106102e65750595b90808252806020026020018201604052506001908051906020019061030c9291906104ef565b5050565b610318610579565b600180548060200260200160405190810160405280929190818152602001828054801561039a57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610350575b5050505050905090565b662386f26fc10000341115156103b957600080fd5b600180548060010182816103cd919061058d565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60018181548110151561042d57fe5b90600052602060002090016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000444260016040518084815260200183815260200182805480156104d757602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161048d575b50509350505050604051809103902060019004905090565b828054828255906000526020600020908101928215610568579160200282015b828111156105675782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019061050f565b5b50905061057591906105b9565b5090565b602060405190810160405280600081525090565b8154818355818115116105b4578183600052602060002091820191016105b391906105fc565b5b505050565b6105f991905b808211156105f557600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055506001016105bf565b5090565b90565b61061e91905b8082111561061a576000816000905550600101610602565b5090565b905600a165627a7a723058204df529d1de884c8b5724c7bae1800c85c95a2e0091a85611be44c3acd3b502780029
deploy bytecode
0x60606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063481c6a75146100695780635d495aea146100be5780638b5b9ccc146100d3578063e97dcb621461013d578063f71d96cb1461014757600080fd5b341561007457600080fd5b61007c6101aa565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156100c957600080fd5b6100d16101cf565b005b34156100de57600080fd5b6100e6610310565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561012957808201518184015260208101905061010e565b505050509050019250505060405180910390f35b6101456103a4565b005b341561015257600080fd5b610168600480803590602001909190505061041e565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561022c57600080fd5b60018054905061023a61045d565b81151561024357fe5b06905060018181548110151561025557fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc3073ffffffffffffffffffffffffffffffffffffffff16319081150290604051600060405180830381858888f1935050505015156102d757600080fd5b60006040518059106102e65750595b90808252806020026020018201604052506001908051906020019061030c9291906104ef565b5050565b610318610579565b600180548060200260200160405190810160405280929190818152602001828054801561039a57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610350575b5050505050905090565b662386f26fc10000341115156103b957600080fd5b600180548060010182816103cd919061058d565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60018181548110151561042d57fe5b90600052602060002090016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000444260016040518084815260200183815260200182805480156104d757602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161048d575b50509350505050604051809103902060019004905090565b828054828255906000526020600020908101928215610568579160200282015b828111156105675782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019061050f565b5b50905061057591906105b9565b5090565b602060405190810160405280600081525090565b8154818355818115116105b4578183600052602060002091820191016105b391906105fc565b5b505050565b6105f991905b808211156105f557600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055506001016105bf565b5090565b90565b61061e91905b8082111561061a576000816000905550600101610602565b5090565b905600a165627a7a723058204df529d1de884c8b5724c7bae1800c85c95a2e0091a85611be44c3acd3b502780029
actual fetched from address
0x60606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063481c6a75146100695780635d495aea146100be5780638b5b9ccc146100d3578063e97dcb621461013d578063f71d96cb1461014757600080fd5b341561007457600080fd5b61007c6101aa565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156100c957600080fd5b6100d16101cf565b005b34156100de57600080fd5b6100e6610310565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561012957808201518184015260208101905061010e565b505050509050019250505060405180910390f35b6101456103a4565b005b341561015257600080fd5b610168600480803590602001909190505061041e565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561022c57600080fd5b60018054905061023a61045d565b81151561024357fe5b06905060018181548110151561025557fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc3073ffffffffffffffffffffffffffffffffffffffff16319081150290604051600060405180830381858888f1935050505015156102d757600080fd5b60006040518059106102e65750595b90808252806020026020018201604052506001908051906020019061030c9291906104ef565b5050565b610318610579565b600180548060200260200160405190810160405280929190818152602001828054801561039a57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610350575b5050505050905090565b662386f26fc10000341115156103b957600080fd5b600180548060010182816103cd919061058d565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60018181548110151561042d57fe5b90600052602060002090016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000444260016040518084815260200183815260200182805480156104d757602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161048d575b50509350505050604051809103902060019004905090565b828054828255906000526020600020908101928215610568579160200282015b828111156105675782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019061050f565b5b50905061057591906105b9565b5090565b602060405190810160405280600081525090565b8154818355818115116105b4578183600052602060002091820191016105b391906105fc565b5b505050565b6105f991905b808211156105f557600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055506001016105bf565b5090565b90565b61061e91905b8082111561061a576000816000905550600101610602565b5090565b905600a165627a7a72305820b788e9bdad96c1e5ebeb216958c6a95ab32ea7e5fb82b6267167ca40d893445b0029
 */